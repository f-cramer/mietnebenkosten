<html lang="de" th:lang="${#locale.language}" xmlns:th="http://www.thymeleaf.org">
<head th:replace="template.html :: head">
    <title></title>
</head>
<body>
<!--/*@thymesVar id="bill" type="de.cramer.nebenkosten.entities.Bill"*/-->
<div class="container" th:with="bill = ${id != null} ? ${@billService.getBill(id)} : null, saveError = ${param.error != null && param.error.contains('save')}, deletionError = ${param.error != null && param.error.contains('delete')}">
    <nav th:replace="template.html :: navbar ('bills')"></nav>

    <form id="saveForm" action="/bills/edit/1" method="post" th:action="${bill != null} ? '/bills/edit/' + ${bill.id} : '/bills/create'"></form>
    <form id="deleteForm" action="/bills/delete/1" method="post" th:action="${bill != null} ? '/bills/delete/' + ${bill.id} : ''"></form>

    <div class="alert alert-danger" role="alert" th:if="${saveError}">
        Beim Speichern des Mietvertrags ist ein Fehler aufgetreten.
    </div>
    <div class="alert alert-danger" role="alert" th:if="${deletionError}">
        Beim Löschen des Mietvertrags ist ein Fehler aufgetreten.
    </div>

    <table class="table table-striped align-middle">
        <tbody>
        <tr>
            <td>Name</td>
            <td>
                <input class="form-control" type="text" name="description" id="description" placeholder="Name" aria-label="Name" form="saveForm" required value="Abwasser" th:value="${bill != null ? bill.description : null}">
            </td>
        </tr>
        <tr>
            <td>Preis</td>
            <td>
                <div class="input-group">
                    <input class="form-control" type="number" name="priceEuro" id="priceEuro" placeholder="Preis" aria-label="Preis Euro" form="saveForm" required min="0" value="1" th:value="${bill != null ? bill.price.amount / 100 : 0}" onchange="setPrice()">
                    <div class="input-group-append"><span class="input-group-text">,</span></div>
                    <input class="form-control" type="number" name="priceCent" id="priceCent" placeholder="Preis" aria-label="Preis Cent" form="saveForm" required min="0" value="1" th:value="${bill != null ? bill.price.amount % 100 : 0}" onchange="setPrice()">
                    <div class="input-group-append"><span class="input-group-text">€</span></div>
                </div>
                <input type="hidden" name="price" id="price" form="saveForm" required min="1"  value="101" th:value="${bill != null ? bill.price.amount : 0}">
            </td>
        </tr>
        <tr>
            <td>Start</td>
            <td>
                <input class="form-control" type="date" name="start" id="start" placeholder="Startdatum" aria-label="Startdatum" form="saveForm" required value="2020-12-14" onchange="checkDates()" th:value="${bill != null ? bill.period.start : T(java.time.LocalDate).now()}">
            </td>
        </tr>
        <tr>
            <td>Ende</td>
            <td class="form-inline">
                <input class="form-control" type="date" name="end" id="end" placeholder="Enddatum" aria-label="Enddatum" form="saveForm" required value="2020-12-14" style="flex-grow: 1;" onchange="checkDates()" th:value="${bill != null ? bill.period.end : null}">
            </td>
        </tr>
        </tbody>
    </table>

    <div class="d-flex flex-row-reverse" style="gap: 0.5rem">
        <button class="btn btn-outline-success my-2 my-sm-0 col-md-2" form="saveForm" type="submit">Speichern</button>
        <button class="btn btn-outline-danger my-2 my-sm-0 col-md-2" form="deleteForm" type="submit" th:if="${bill != null}">Löschen</button>
        <a class="btn btn-outline-danger my-2 my-sm-0 col-md-2" href="/bills" th:if="${bill == null}">Abbrechen</a>
    </div>

    <script>
        function checkDates() {
            const start = document.getElementById("start");
            const end = document.getElementById("end");

            const startValue = start.value;
            const endValue = end.value;

            if (endValue && startValue > endValue) {
                end.setCustomValidity("Ende kann nicht vor Start liegen")
            } else {
                end.setCustomValidity('')
            }
        }

        function setPrice() {
            const priceEuro = document.getElementById("priceEuro")
            const priceCent = document.getElementById("priceCent")
            const price = document.getElementById("price")

            const fullPrice = (parseFloat(priceEuro.value || "0") * 100) + parseFloat(priceCent.value || "0")
            price.value = fullPrice
            if (fullPrice <= 0) {
                price.setCustomValidity("Preis muss größer 0 sein")
            } else {
                price.setCustomValidity("")
            }
        }
    </script>
</div>
</body>
</html>
